import streamlit as st
import torch
from transformers import (
    pipeline,
    AutoTokenizer,
    AutoModelForSeq2SeqLM,
    MarianMTModel,
    MarianTokenizer
)
import warnings
warnings.filterwarnings('ignore')

# Cache cÃ¡c mÃ´ hÃ¬nh Ä‘á»ƒ tÄƒng tá»‘c Ä‘á»™ táº£i
@st.cache_resource
def load_translation_models():
    """
    Táº£i táº¥t cáº£ cÃ¡c mÃ´ hÃ¬nh dá»‹ch vÃ  cache láº¡i Ä‘á»ƒ sá»­ dá»¥ng sau nÃ y
    """
    models = {}
    
    try:
        # Anh -> Viá»‡t
        models['en_vi'] = pipeline(
            "translation_en_to_vi", 
            model="VietAI/envit5-translation"
        )
    except:
        # Fallback model
        models['en_vi'] = pipeline(
            "translation",
            model="Helsinki-NLP/opus-mt-en-vi"
        )
    
    try:
        # Viá»‡t -> Anh
        models['vi_en'] = pipeline(
            "translation_vi_to_en", 
            model="VietAI/envit5-translation"
        )
    except:
        models['vi_en'] = pipeline(
            "translation",
            model="Helsinki-NLP/opus-mt-vi-en"
        )
    
    try:
        # Anh -> Trung
        models['en_zh'] = pipeline(
            "translation_en_to_zh",
            model="Helsinki-NLP/opus-mt-en-zh"
        )
    except:
        # Alternative model
        models['en_zh'] = pipeline(
            "translation",
            model="t5-small"
        )
    
    try:
        # Trung -> Anh
        models['zh_en'] = pipeline(
            "translation_zh_to_en",
            model="Helsinki-NLP/opus-mt-zh-en"
        )
    except:
        models['zh_en'] = pipeline(
            "translation",
            model="t5-small"
        )
    
    # ThÃªm cÃ¡c model cho dá»‹ch trá»±c tiáº¿p Viá»‡t-Trung vÃ  ngÆ°á»£c láº¡i
    try:
        # Sá»­ dá»¥ng model Ä‘a ngÃ´n ngá»¯ cho cÃ¡c cáº·p ngÃ´n ngá»¯ khÃ´ng cÃ³ model trá»±c tiáº¿p
        models['vi_zh'] = pipeline(
            "translation",
            model="Helsinki-NLP/opus-mt-mul-en"
        )
        models['zh_vi'] = pipeline(
            "translation", 
            model="Helsinki-NLP/opus-mt-mul-en"
        )
    except:
        # Fallback to English as pivot
        models['vi_zh'] = None
        models['zh_vi'] = None
    
    return models

def translate_with_pivot(text, src_lang, tgt_lang, models):
    """
    Dá»‹ch sá»­ dá»¥ng tiáº¿ng Anh lÃ m ngÃ´n ngá»¯ trung gian (pivot)
    khi khÃ´ng cÃ³ model dá»‹ch trá»±c tiáº¿p
    """
    if src_lang == 'vi' and tgt_lang == 'zh':
        if models['vi_zh'] is not None:
            return models['vi_zh'](text)[0]['translation_text']
        else:
            # Dá»‹ch Viá»‡t -> Anh -> Trung
            english_text = models['vi_en'](text)[0]['translation_text']
            return models['en_zh'](english_text)[0]['translation_text']
    
    elif src_lang == 'zh' and tgt_lang == 'vi':
        if models['zh_vi'] is not None:
            return models['zh_vi'](text)[0]['translation_text']
        else:
            # Dá»‹ch Trung -> Anh -> Viá»‡t
            english_text = models['zh_en'](text)[0]['translation_text']
            return models['en_vi'](english_text)[0]['translation_text']
    
    else:
        return "PhÆ°Æ¡ng thá»©c dá»‹ch khÃ´ng Ä‘Æ°á»£c há»— trá»£"

def main():
    # Cáº¥u hÃ¬nh trang
    st.set_page_config(
        page_title="Dá»‹ch Äa NgÃ´n Ngá»¯",
        page_icon="ğŸŒ",
        layout="wide"
    )
    
    # TiÃªu Ä‘á» á»©ng dá»¥ng
    st.title("ğŸŒ á»¨ng Dá»¥ng Dá»‹ch Äa NgÃ´n Ngá»¯")
    st.markdown("### Sá»­ dá»¥ng mÃ´ hÃ¬nh Transformer Ä‘á»ƒ dá»‹ch giá»¯a Tiáº¿ng Anh, Tiáº¿ng Viá»‡t vÃ  Tiáº¿ng Trung")
    
    # Hiá»ƒn thá»‹ thanh tiáº¿n trÃ¬nh khi táº£i model
    with st.spinner('Äang táº£i cÃ¡c mÃ´ hÃ¬nh dá»‹ch... Vui lÃ²ng chá» trong giÃ¢y lÃ¡t.'):
        models = load_translation_models()
    
    st.success('âœ… ÄÃ£ táº£i xong táº¥t cáº£ mÃ´ hÃ¬nh dá»‹ch!')
    
    # Táº¡o layout
    col1, col2 = st.columns([1, 1])
    
    with col1:
        st.subheader("ğŸ“¥ Nháº­p vÄƒn báº£n cáº§n dá»‹ch")
        
        # Chá»n ngÃ´n ngá»¯ nguá»“n
        src_lang = st.selectbox(
            "NgÃ´n ngá»¯ nguá»“n",
            ["Tiáº¿ng Anh", "Tiáº¿ng Viá»‡t", "Tiáº¿ng Trung"],
            key="src_lang"
        )
        
        # Ãnh xáº¡ tÃªn ngÃ´n ngá»¯ sang code
        lang_map = {
            "Tiáº¿ng Anh": "en",
            "Tiáº¿ng Viá»‡t": "vi", 
            "Tiáº¿ng Trung": "zh"
        }
        
        # Text area cho input
        input_text = st.text_area(
            "VÄƒn báº£n cáº§n dá»‹ch:",
            height=150,
            placeholder="Nháº­p vÄƒn báº£n cáº§n dá»‹ch táº¡i Ä‘Ã¢y..."
        )
    
    with col2:
        st.subheader("ğŸ“¤ Káº¿t quáº£ dá»‹ch")
        
        # Chá»n ngÃ´n ngá»¯ Ä‘Ã­ch
        tgt_lang = st.selectbox(
            "NgÃ´n ngá»¯ Ä‘Ã­ch",
            ["Tiáº¿ng Anh", "Tiáº¿ng Viá»‡t", "Tiáº¿ng Trung"],
            key="tgt_lang"
        )
        
        # Hiá»ƒn thá»‹ káº¿t quáº£ dá»‹ch
        translation_placeholder = st.empty()
    
    # ThÃ´ng tin thÃªm
    with st.expander("â„¹ï¸ HÆ°á»›ng dáº«n sá»­ dá»¥ng"):
        st.markdown("""
        ### CÃ¡ch sá»­ dá»¥ng:
        1. **Chá»n ngÃ´n ngá»¯ nguá»“n** - ngÃ´n ngá»¯ cá»§a vÄƒn báº£n gá»‘c
        2. **Chá»n ngÃ´n ngá»¯ Ä‘Ã­ch** - ngÃ´n ngá»¯ báº¡n muá»‘n dá»‹ch sang
        3. **Nháº­p vÄƒn báº£n** vÃ o Ã´ bÃªn trÃ¡i
        4. **Nháº¥n nÃºt 'Dá»‹ch'** Ä‘á»ƒ xem káº¿t quáº£
        
        ### Há»— trá»£ cÃ¡c cáº·p ngÃ´n ngá»¯:
        - ğŸ‡¬ğŸ‡§ **Tiáº¿ng Anh** â†” ğŸ‡»ğŸ‡³ **Tiáº¿ng Viá»‡t**
        - ğŸ‡¬ğŸ‡§ **Tiáº¿ng Anh** â†” ğŸ‡¨ğŸ‡³ **Tiáº¿ng Trung** 
        - ğŸ‡»ğŸ‡³ **Tiáº¿ng Viá»‡t** â†” ğŸ‡¨ğŸ‡³ **Tiáº¿ng Trung** (sá»­ dá»¥ng tiáº¿ng Anh lÃ m trung gian)
        
        ### LÆ°u Ã½:
        - á»¨ng dá»¥ng sá»­ dá»¥ng cÃ¡c mÃ´ hÃ¬nh AI Ä‘Æ°á»£c huáº¥n luyá»‡n sáºµn
        - Káº¿t quáº£ dá»‹ch cÃ³ thá»ƒ khÃ´ng hoÃ n háº£o 100%
        - Vá»›i vÄƒn báº£n dÃ i, thá»i gian dá»‹ch cÃ³ thá»ƒ lÃ¢u hÆ¡n
        """)
    
    # NÃºt dá»‹ch
    col1, col2, col3 = st.columns([1, 2, 1])
    with col2:
        translate_btn = st.button(
            "ğŸš€ Dá»‹ch Ngay", 
            type="primary", 
            use_container_width=True
        )
    
    # Xá»­ lÃ½ dá»‹ch khi nháº¥n nÃºt
    if translate_btn and input_text.strip():
        with st.spinner('Äang xá»­ lÃ½ dá»‹ch...'):
            try:
                src_code = lang_map[src_lang]
                tgt_code = lang_map[tgt_lang]
                
                # Kiá»ƒm tra náº¿u cÃ¹ng ngÃ´n ngá»¯
                if src_code == tgt_code:
                    result = input_text
                
                # Dá»‹ch trá»±c tiáº¿p cÃ³ sáºµn model
                elif f"{src_code}_{tgt_code}" in models:
                    model_key = f"{src_code}_{tgt_code}"
                    result = models[model_key](input_text)[0]['translation_text']
                
                # Dá»‹ch sá»­ dá»¥ng pivot
                else:
                    result = translate_with_pivot(input_text, src_code, tgt_code, models)
                
                # Hiá»ƒn thá»‹ káº¿t quáº£
                translation_placeholder.success("âœ… Dá»‹ch thÃ nh cÃ´ng!")
                translation_placeholder.text_area(
                    "Báº£n dá»‹ch:",
                    value=result,
                    height=150,
                    key="translation_result"
                )
                
                # Thá»‘ng kÃª
                st.markdown("---")
                col1, col2, col3 = st.columns(3)
                with col1:
                    st.metric("Äá»™ dÃ i vÄƒn báº£n gá»‘c", f"{len(input_text)} kÃ½ tá»±")
                with col2:
                    st.metric("Äá»™ dÃ i báº£n dá»‹ch", f"{len(result)} kÃ½ tá»±")
                with col3:
                    st.metric("Cáº·p ngÃ´n ngá»¯", f"{src_code.upper()} â†’ {tgt_code.upper()}")
                    
            except Exception as e:
                st.error(f"âŒ CÃ³ lá»—i xáº£y ra khi dá»‹ch: {str(e)}")
    
    elif translate_btn and not input_text.strip():
        st.warning("âš ï¸ Vui lÃ²ng nháº­p vÄƒn báº£n cáº§n dá»‹ch")

    # Footer
    st.markdown("---")
    st.markdown(
        "ğŸ›  **á»¨ng dá»¥ng Ä‘Æ°á»£c xÃ¢y dá»±ng báº±ng Streamlit vÃ  Transformers** | "
        "ğŸ“š **MÃ´ hÃ¬nh tá»« Hugging Face Hub** | "
        "âš¡ **Powered by PyTorch**"
    )

if __name__ == "__main__":
    main()
